<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î™®Î∞îÏùº Ìö°Ïä§ÌÅ¨Î°§ RPG: ÏóêÌîΩ ÏõîÎìú (Extended)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Arial', sans-serif;
            user-select: none;
            touch-action: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        canvas {
            display: block;
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        /* ÏÉÅÎã® UI */
        .top-ui {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            pointer-events: auto;
        }
        .status-card {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .xp-container {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }
        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #6b46c1, #b794f4);
            width: 0%;
            transition: width 0.3s;
        }
        .hp-text { color: #f56565; font-weight: bold; }
        
        .quest-card {
            background: rgba(251, 191, 36, 0.95);
            color: #000;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: bold;
            align-self: flex-end;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid #fff;
        }
        
        /* ÌïòÎã® Ïª®Ìä∏Î°§Îü¨ */
        .controls {
            position: absolute;
            bottom: 60px; 
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: auto;
        }
        .control-group {
            display: flex;
            gap: 12px;
        }
        .btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            transition: transform 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        .btn:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }
        .btn-action { background: rgba(237, 137, 54, 0.5); border-color: #ed8936; }
        .btn-attack { background: rgba(245, 101, 101, 0.5); border-color: #f56565; }
        .btn-dash { background: rgba(66, 153, 225, 0.5); border-color: #4299e1; } /* ÎåÄÏãú Î≤ÑÌäº Ï∂îÍ∞Ä */

        .dialog-box {
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            background: rgba(26, 32, 44, 0.98);
            border: 2px solid #a0aec0;
            padding: 15px;
            border-radius: 12px;
            display: none;
            pointer-events: auto;
            z-index: 100;
            color: white;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }
        .shop-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a202c;
            padding: 20px;
            border-radius: 16px;
            display: none;
            pointer-events: auto;
            z-index: 101;
            width: 85%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #ed8936;
        }
        #hidden-media { display: none; }
        
        .level-up-overlay {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            color: #fbbf24;
            text-shadow: 0 0 10px #b794f4;
            pointer-events: none;
            display: none;
            z-index: 200;
        }
        .level-up-active {
            display: block;
            animation: levelUpAnim 2s forwards;
        }
        @keyframes levelUpAnim {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        /* Ïä§ÌÇ¨ Ïø®ÌÉÄÏûÑ ÌëúÏãú */
        .cooldown-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: none;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="hidden-media">
        <video id="jump-sound-vid" src="https://github.com/caxs23/runandjump/blob/main/jump.mp4?raw=true" preload="auto"></video>
        <audio id="bgm" src="https://orangefreesounds.com/wp-content/uploads/2021/05/Light-fantasy-background-music.mp3" loop></audio>
    </div>

    <div class="level-up-overlay" id="lvl-up-msg">LEVEL UP!</div>

    <div class="ui-overlay">
        <div class="top-ui">
            <div class="status-card">
                <div class="flex flex-col w-full">
                    <div class="flex justify-between items-center w-full mb-1">
                        <div class="flex gap-2 text-sm">
                            <span class="text-yellow-400 font-bold">LV.<span id="level">1</span></span>
                            <span class="hp-text">HP <span id="hp">100</span>/<span id="max-hp">100</span></span>
                        </div>
                        <div class="font-bold text-gray-300 text-xs">üìç <span id="location-name">ÎßàÏùÑ</span></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>üí∞ <span id="gold">0</span></span>
                        <span>‚öîÔ∏è <span id="power">10</span></span>
                        <span>üì¶ <span id="loot">0</span></span>
                    </div>
                    <div class="xp-container">
                        <div id="xp-bar" class="xp-bar"></div>
                    </div>
                </div>
            </div>
            <div id="quest-ui" class="quest-card">
                üìú <span id="quest-desc">ÏÉÅÏù∏Í≥º ÎåÄÌôîÌïòÍ∏∞</span>
            </div>
        </div>

        <div id="dialog" class="dialog-box">
            <div id="speaker-name" class="font-bold text-blue-300 mb-1">ÏÉÅÏù∏</div>
            <p id="dialog-text" class="text-sm">Ï†ÑÎ¶¨ÌíàÏùÑ ÌåîÎü¨ ÏôîÎÇò?</p>
            <div id="dialog-buttons" class="mt-3 flex flex-wrap gap-2"></div>
        </div>

        <div id="shop" class="shop-menu text-white">
            <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                <h2 class="text-xl font-bold text-orange-400">Ï†ÑÏÑ§Ïùò ÎåÄÏû•Í∞Ñ</h2>
                <div class="text-sm">üí∞ <span id="shop-gold">0</span></div>
            </div>
            <div id="shop-items" class="space-y-2"></div>
            <button onclick="toggleShop()" class="mt-4 w-full bg-gray-600 py-3 rounded-xl font-bold">ÏÉÅÏ†ê Îã´Í∏∞</button>
        </div>

        <div class="controls">
            <div class="control-group">
                <div id="btn-left" class="btn">‚óÄ</div>
                <div id="btn-right" class="btn">‚ñ∂</div>
            </div>
            <div class="control-group">
                <div id="btn-dash" class="btn btn-dash relative">
                    DASH
                    <div id="dash-cd" class="cooldown-overlay"></div>
                </div>
                <div id="btn-jump" class="btn">UP</div>
                <div id="btn-attack" class="btn btn-attack">ATK</div>
                <div id="btn-action" class="btn btn-action">ACT</div>
            </div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const jumpVid = document.getElementById('jump-sound-vid');
const bgm = document.getElementById('bgm');

// --- GAME STATE ---
const state = {
    gold: 0,
    loot: 0,
    attackPower: 10,
    weaponLevel: 1,
    location: 'town_start',
    dialogVisible: false,
    shopVisible: false,
    audioInitialized: false,
    questStep: 0,
    kills: 0,
    chestsFound: [],
    level: 1,
    xp: 0,
    maxXp: 100,
    hp: 100,
    maxHp: 100,
    screenShake: 0,
    time: 0,
    mapWidth: 2000 // Í∏∞Î≥∏ Îßµ ÎÑàÎπÑ (ÌôïÏû•Îê®)
};

const camera = { x: 0, y: 0 };

// --- MAP CONFIG ---
const locations = {
    'town_start': { name: 'ÏãúÏûëÏùò ÎßàÏùÑ', next: 'field_slime', prev: null, bg: '#87CEEB', type: 'town', width: 2000 },
    'field_slime': { name: 'Ïä¨ÎùºÏûÑ ÌèâÏõê', next: 'field_forest_1', prev: 'town_start', bg: '#7cfc00', type: 'field', enemy: 'üíß', weather: 'none', width: 3000 },
    'field_forest_1': { name: 'Í≥†ÏöîÌïú Ïà≤', next: 'field_forest_2', prev: 'field_slime', bg: '#2d5a27', type: 'field', enemy: 'üê∞', weather: 'none', width: 3000 },
    'field_forest_2': { name: 'ÍπäÏùÄ Ïà≤', next: 'field_bridge', prev: 'field_forest_1', bg: '#1a3c18', type: 'field', enemy: 'ü¶ä', weather: 'rain', width: 3500 },
    'field_bridge': { name: 'Ïò§ÎûòÎêú Îã§Î¶¨', next: 'town_second', prev: 'field_forest_2', bg: '#4a7c59', type: 'field', enemy: 'üêó', weather: 'rain', width: 2500 },
    'town_second': { name: 'Î¨¥Ïó≠ ÎèÑÏãú', next: 'field_desert_1', prev: 'field_bridge', bg: '#fbd38d', type: 'town', width: 2500 },
    'field_desert_1': { name: 'Î©îÎßàÎ•∏ ÏÇ¨Îßâ', next: 'field_desert_2', prev: 'town_second', bg: '#ecc94b', type: 'field', enemy: 'ü¶Ç', weather: 'none', width: 3500 },
    'field_desert_2': { name: 'Î™®Îûò Ìè≠Ìíç', next: 'field_oasis', prev: 'field_desert_1', bg: '#d69e2e', type: 'field', enemy: 'üåµ', weather: 'sand', width: 3500 },
    'field_oasis': { name: 'Ïò§ÏïÑÏãúÏä§', next: 'field_cave_1', prev: 'field_desert_2', bg: '#4fd1c5', type: 'field', enemy: 'üêç', weather: 'none', width: 2000 },
    'field_cave_1': { name: 'ÎèôÍµ¥ ÏûÖÍµ¨', next: 'field_cave_2', prev: 'field_oasis', bg: '#4a5568', type: 'field', enemy: 'ü¶á', weather: 'dark', width: 3000 },
    'field_cave_2': { name: 'Ïã¨Ïó∞Ïùò ÎèôÍµ¥', next: 'field_volcano', prev: 'field_cave_1', bg: '#2d3748', type: 'field', enemy: 'üï∑Ô∏è', weather: 'dark', width: 3500 },
    'field_volcano': { name: 'Ïö©Ïïî ÏßÄÎåÄ', next: 'town_castle', prev: 'field_cave_2', bg: '#c53030', type: 'field', enemy: 'üî•', weather: 'ash', width: 4000 },
    'town_castle': { name: 'ÏµúÌõÑÏùò ÏöîÏÉà', next: 'field_snow', prev: 'field_volcano', bg: '#718096', type: 'town', width: 2000 },
    'field_snow': { name: 'ÏÑ§Ïõê', next: 'field_sky', prev: 'town_castle', bg: '#e2e8f0', type: 'field', enemy: 'üê∫', weather: 'snow', width: 4000 },
    'field_sky': { name: 'ÌïòÎäò ÏÑ¨', next: 'boss_lair', prev: 'field_snow', bg: '#ebf8ff', type: 'field', enemy: 'ü¶Ö', weather: 'none', width: 3000 },
    'boss_lair': { name: 'ÎßàÏôïÏùò ÏÑ±', next: null, prev: 'field_sky', bg: '#1a202c', type: 'field', enemy: 'üëø', weather: 'thunder', width: 2000 }
};

const playerImg1 = new Image(); playerImg1.src = 'https://github.com/caxs23/plaffy-bird/blob/main/1-removebg-preview.png?raw=true';
const playerImg2 = new Image(); playerImg2.src = 'https://github.com/caxs23/plaffy-bird/blob/main/2-removebg-preview.png?raw=true';

const GRAVITY = 0.6;
const GROUND_Y = 0.75;

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

const keys = { left: false, right: false, jump: false };

// --- VISUAL & GAMEPLAY OBJECTS ---
const particles = [];
const damageTexts = [];
const droppedItems = [];
const monsters = [];
const villagers = [];
const chests = [];

function initAudio() {
    if (!state.audioInitialized) { bgm.play().catch(() => {}); state.audioInitialized = true; }
}

function playJumpEffect() { jumpVid.currentTime = 0; jumpVid.play().catch(() => {}); }

class Particle {
    constructor(x, y, color, type = 'normal') {
        this.x = x; this.y = y;
        this.vx = (Math.random() - 0.5) * 8;
        this.vy = (Math.random() - 0.5) * 8;
        this.life = 1.0;
        this.color = color;
        this.type = type;
        if (type === 'rain') { this.vx = -4; this.vy = 15; this.life = 0.8; }
        if (type === 'snow') { this.vx = Math.random() - 0.5; this.vy = 2; this.life = 1.5; }
        if (type === 'sand') { this.vx = -15; this.vy = Math.random() * 2; this.life = 0.8; }
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        if (this.type === 'normal') this.life -= 0.03;
        else if (this.y > canvas.height) { 
            if(this.type === 'rain' || this.type === 'snow') this.y = -10; 
            else this.life = 0;
        }
        if (this.type === 'sand' && this.x < 0) this.x = canvas.width + 10;
    }
    draw() {
        ctx.fillStyle = this.color;
        // ÎπÑ/Îàà/Î™®ÎûòÎäî ÌôîÎ©¥ Ï†ÑÏ≤¥Ïóê Ìù©ÎøåÎ†§ÏßÄÎØÄÎ°ú Ïπ¥Î©îÎùº ÏòÅÌñ•ÏùÑ Î∞õÏßÄ ÏïäÍ±∞ÎÇò, 
        // ÌòπÏùÄ ÏõîÎìú Ï¢åÌëúÍ≥ÑÎùºÎ©¥ Ïπ¥Î©îÎùº Î≥¥Ï†ïÏùÑ Î∞õÏïÑÏïº Ìï®. 
        // Ïó¨Í∏∞ÏÑúÎäî ÎÇ†Ïî® Ìö®Í≥ºÎäî 'Ïä§ÌÅ¨Î¶∞ Ï¢åÌëúÍ≥Ñ'Î°ú Ï≤òÎ¶¨ÌïòÏó¨ Ïπ¥Î©îÎùºÏôÄ Î¨¥Í¥ÄÌïòÍ≤å ÎøåÎ¶º.
        if (this.type !== 'normal') {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform for UI/Weather
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.type==='normal'?4:2, this.type==='normal'?4:(this.type==='sand'?2:8));
            ctx.restore();
        } else {
            // ÏùºÎ∞ò ÌååÌã∞ÌÅ¥(ÌÉÄÍ≤© Ìö®Í≥º Îì±)ÏùÄ ÏõîÎìú Ï¢åÌëú
            ctx.fillRect(this.x, this.y, 4, 4);
        }
    }
}

class DamageText {
    constructor(x, y, damage, isCrit) {
        this.x = x; this.y = y;
        this.text = damage;
        this.isCrit = isCrit;
        this.life = 1.0;
        this.vy = -2;
    }
    update() {
        this.y += this.vy;
        this.life -= 0.02;
    }
    draw() {
        ctx.save();
        ctx.font = this.isCrit ? 'bold 24px Arial' : 'bold 18px Arial';
        ctx.fillStyle = this.isCrit ? '#ffff00' : '#ffffff';
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 3;
        ctx.strokeText(this.text, this.x, this.y);
        ctx.fillText(this.text, this.x, this.y);
        if (this.isCrit) ctx.fillText("CRIT!", this.x, this.y - 20);
        ctx.restore();
    }
}

class DroppedItem {
    constructor(x, y, type) {
        this.x = x; this.y = y;
        this.type = type; 
        this.vy = -5; 
        this.groundY = y;
        this.bounced = false;
        this.life = 1000;
    }
    update() {
        this.vy += GRAVITY;
        this.y += this.vy;
        if (this.y > this.groundY) {
            this.y = this.groundY;
            if (!this.bounced) { this.vy = -3; this.bounced = true; }
            else { this.vy = 0; }
        }
        this.life--;
    }
    draw() {
        ctx.font = '24px serif';
        ctx.fillText(this.type === 'gold' ? 'üí∞' : '‚ù§Ô∏è', this.x, this.y);
    }
}

class Entity {
    constructor(x, y, size, emoji, hp = 0, isNpc = false, isElite = false) {
        this.x = x; this.y = y; this.size = size; this.emoji = emoji;
        this.isNpc = isNpc;
        this.isElite = isElite;
        this.maxHp = hp * (isElite ? 3 : 1);
        this.hp = this.maxHp;
        this.dead = false; this.vx = 0; this.moveTimer = 0;
        this.hitTimer = 0;
        if (isElite) this.size *= 1.5;
        this.homeX = x; // Î∞∞Ìöå Í∏∞Ï§ÄÏ†ê
    }

    update() {
        if (this.dead) return;
        this.moveTimer--;
        if (this.moveTimer <= 0) {
            this.moveTimer = 60 + Math.random() * 120;
            const r = Math.random();
            this.vx = r < 0.3 ? 0 : (r < 0.65 ? 1 : -1);
        }
        this.x += this.vx * (this.isNpc ? 0.3 : 0.8);
        
        // Î∞∞Ìöå Î≤îÏúÑ Ï†úÌïú (Ïä§Ìè∞ ÏúÑÏπò Í∏∞Ï§Ä +- 300)
        if (this.x < this.homeX - 300) this.vx = 1;
        if (this.x > this.homeX + 300) this.vx = -1;
        if (this.hitTimer > 0) this.hitTimer--;
    }

    draw() {
        if (this.dead) return;
        ctx.save();
        if (this.hitTimer > 0) ctx.filter = 'brightness(2) sepia(1) hue-rotate(-50deg)';
        ctx.font = `${this.size}px serif`;
        ctx.textAlign = 'center';
        
        if (this.isElite) {
            ctx.shadowColor = "yellow";
            ctx.shadowBlur = 15;
        }

        ctx.fillStyle = '#FFFFFF';
        ctx.fillText(this.emoji, this.x, this.y + this.size);
        ctx.shadowBlur = 0;

        if (this.hp > 0 && !this.isNpc) {
            const barW = this.size;
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(this.x - barW/2, this.y - 15, barW, 4);
            ctx.fillStyle = this.isElite ? '#FFD700' : '#00FF00';
            ctx.fillRect(this.x - barW/2, this.y - 15, barW * (this.hp / this.maxHp), 4);
        }
        ctx.restore();
    }
}

class Chest {
    constructor(x, y) {
        this.x = x; this.y = y; this.id = `${state.location}_${Math.floor(x)}`;
        this.opened = state.chestsFound.includes(this.id);
    }
    draw() {
        ctx.save();
        ctx.font = '40px serif';
        ctx.textAlign = 'center';
        ctx.fillText(this.opened ? 'üîì' : 'üéÅ', this.x, this.y);
        if (!this.opened) {
            ctx.fillStyle = 'yellow';
            ctx.globalAlpha = 0.6 + Math.sin(Date.now()/200)*0.4;
            ctx.beginPath();
            ctx.arc(this.x, this.y - 20, 30, 0, Math.PI*2);
            ctx.fill();
        }
        ctx.restore();
    }
}

const player = {
    x: 100, y: 0, width: 70, height: 65, vx: 0, vy: 0,
    speed: 6, jumpPower: -13, isGrounded: false, direction: 1,
    frame: 0, walkCounter: 0, isAttacking: false, attackCooldown: 0,
    dashCooldown: 0, isDashing: false,

    update() {
        // Horizontal Movement
        if (keys.left) { this.vx = -this.speed; this.direction = -1; this.walkCounter++; }
        else if (keys.right) { this.vx = this.speed; this.direction = 1; this.walkCounter++; }
        else { this.vx *= 0.8; this.walkCounter = 0; }

        // Dash Logic
        if (this.isDashing) {
            this.vx = this.direction * 15; // Fast speed
            spawnParticle(this.x + this.width/2, this.y + this.height/2, '#87CEEB', 1);
        }
        if (this.dashCooldown > 0) this.dashCooldown--;

        // Jump
        if (keys.jump && this.isGrounded) { this.vy = this.jumpPower; this.isGrounded = false; playJumpEffect(); }
        
        this.vy += GRAVITY;
        this.x += this.vx;
        this.y += this.vy;

        // Ground Collision
        const g = canvas.height * GROUND_Y - this.height;
        if (this.y > g) { this.y = g; this.vy = 0; this.isGrounded = true; }

        // Map Boundaries (Scrolling World)
        if (this.x < 0) {
            if (locations[state.location].prev) {
                state.location = locations[state.location].prev;
                // Move to end of previous map
                const prevMapWidth = locations[state.location].width;
                this.x = prevMapWidth - 100;
                changeLocation();
            } else {
                this.x = 0;
            }
        }
        if (this.x > state.mapWidth - this.width) {
            if (locations[state.location].next) {
                state.location = locations[state.location].next;
                this.x = 50;
                changeLocation();
            } else {
                this.x = state.mapWidth - this.width;
            }
        }

        if (this.attackCooldown > 0) this.attackCooldown--;
        if (this.attackCooldown < 12) this.isAttacking = false;
        this.frame = (Math.floor(this.walkCounter / 8) % 2);

        // Pick Items
        for (let i = droppedItems.length - 1; i >= 0; i--) {
            const item = droppedItems[i];
            const dist = Math.abs((this.x + this.width/2) - item.x);
            if (dist < 60) {
                if (item.type === 'gold') {
                    state.gold += 10 + Math.floor(Math.random() * 20); 
                    spawnParticle(item.x, item.y, '#ffd700', 5);
                } else if (item.type === 'heart') {
                    state.hp = Math.min(state.hp + 20, state.maxHp);
                    spawnParticle(item.x, item.y, '#ff0000', 5);
                }
                droppedItems.splice(i, 1);
                updateUI();
            }
        }
    },

    draw() {
        ctx.save();
        if (this.direction === -1) { ctx.scale(-1, 1); ctx.translate(-this.x - this.width, this.y); }
        else { ctx.translate(this.x, this.y); }
        const img = (this.walkCounter > 0 || !this.isGrounded) ? (this.frame === 0 ? playerImg1 : playerImg2) : playerImg1;
        
        if (this.isDashing) {
            ctx.globalAlpha = 0.5; // Ghost effect
            ctx.drawImage(img, -20, 0, this.width, this.height);
            ctx.globalAlpha = 1.0;
        }

        if (this.isAttacking) {
            ctx.strokeStyle = 'rgba(255,255,255,0.8)';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(this.width, this.height/2, 40, -Math.PI/2, Math.PI/2);
            ctx.stroke();
        }
        ctx.drawImage(img, 0, 0, this.width, this.height);
        ctx.restore();
    },

    dash() {
        if (this.dashCooldown <= 0) {
            this.isDashing = true;
            this.dashCooldown = 60; // 1 sec cooldown
            document.getElementById('dash-cd').style.display = 'block';
            setTimeout(() => { this.isDashing = false; }, 200);
            setTimeout(() => { document.getElementById('dash-cd').style.display = 'none'; }, 1000);
        }
    }
};

player.attack = function() {
    if (this.attackCooldown > 0) return;
    this.isAttacking = true; this.attackCooldown = 25;
    spawnParticle(this.x + this.width/2, this.y + this.height/2, '#fff', 5);
    
    const targets = [...monsters, ...villagers];
    targets.forEach(m => {
        if (!m.dead) {
            const dist = Math.abs((this.x + this.width/2) - m.x);
            if (dist < 120) {
                const isCrit = Math.random() < 0.2;
                const dmg = Math.floor(state.attackPower * (isCrit ? 2 : 1) * (0.9 + Math.random() * 0.2));
                
                m.hp -= dmg;
                m.hitTimer = 10;
                state.screenShake = 5;
                
                damageTexts.push(new DamageText(m.x, m.y, dmg, isCrit));
                spawnParticle(m.x, m.y + m.size/2, '#ff0000', 8);

                if (m.isNpc) { 
                    showDialog("Ï£ºÎØº", "ÏúºÏïÖ! ÏÇ¥Î†§Ï£ºÏÑ∏Ïöî!"); 
                    m.vx = this.direction * 4; 
                }
                if (m.hp <= 0) {
                    m.dead = true;
                    if (!m.isNpc) {
                        state.kills++;
                        gainXp(m.isElite ? 50 : 15);
                        droppedItems.push(new DroppedItem(m.x, m.y, 'gold'));
                        if (Math.random() < 0.3) droppedItems.push(new DroppedItem(m.x + 10, m.y, 'gold'));
                        if (Math.random() < 0.2) droppedItems.push(new DroppedItem(m.x - 10, m.y, 'heart'));
                        if (m.isElite) {
                            state.loot += 3;
                            for(let k=0; k<5; k++) droppedItems.push(new DroppedItem(m.x + (k*5), m.y, 'gold'));
                        } else {
                            state.loot++;
                        }
                        checkQuest();
                    } else {
                        state.gold = Math.max(0, state.gold - 100);
                    }
                    updateUI();
                }
            }
        }
    });
};

function spawnParticle(x, y, color, count) {
    for (let i = 0; i < count; i++) {
        particles.push(new Particle(x, y, color));
    }
}

function gainXp(amount) {
    state.xp += amount;
    if (state.xp >= state.maxXp) {
        state.xp -= state.maxXp;
        state.level++;
        state.maxXp = Math.floor(state.maxXp * 1.5);
        state.maxHp += 20;
        state.hp = state.maxHp;
        state.attackPower += 5;
        
        const msg = document.getElementById('lvl-up-msg');
        msg.classList.remove('level-up-active');
        void msg.offsetWidth; 
        msg.classList.add('level-up-active');
        spawnParticle(player.x, player.y, '#ffd700', 30);
    }
    updateUI();
}

function changeLocation() {
    state.mapWidth = locations[state.location].width;
    monsters.length = 0; villagers.length = 0; chests.length = 0; droppedItems.length = 0; particles.length = 0;
    const loc = locations[state.location];
    
    // Create Weather Particles
    if (loc.weather !== 'none') {
        const pCount = loc.weather === 'sand' ? 50 : 100;
        for(let i=0; i<pCount; i++) {
            particles.push(new Particle(Math.random()*canvas.width, Math.random()*canvas.height, 
                loc.weather==='rain'?'#a0aec0':(loc.weather==='snow'?'#fff':'#d69e2e'), loc.weather));
        }
    }

    if (loc.type === 'town') {
        // Town width based population
        const count = Math.floor(state.mapWidth / 400); 
        for (let i = 0; i < count; i++) {
            villagers.push(new Entity(300 + Math.random() * (state.mapWidth - 600), canvas.height * GROUND_Y - 45, 50, ['üë¶', 'üë©', 'üë¥', 'üëÆ', 'ü§¥'][Math.floor(Math.random()*5)], 100, true));
        }
    } else {
        // Field Monsters
        const count = Math.floor(state.mapWidth / 500);
        const hpBase = state.location === 'boss_lair' ? 5000 : 50 + (state.level * 20);
        
        if (state.location === 'boss_lair') {
             monsters.push(new Entity(state.mapWidth/2, canvas.height * GROUND_Y - 100, 100, 'üëø', 10000, false, true));
        } else {
            for (let i = 0; i < count; i++) {
                const isElite = Math.random() < 0.15;
                monsters.push(new Entity(
                    400 + Math.random() * (state.mapWidth - 800), 
                    canvas.height * GROUND_Y - (isElite ? 70 : 55), 
                    isElite ? 70 : 55, 
                    loc.enemy, 
                    hpBase,
                    false,
                    isElite
                ));
            }
        }
    }
    // Random Chests
    const chestCount = Math.floor(state.mapWidth / 1000);
    for(let i=0; i<chestCount; i++) {
        if (Math.random() > 0.4) {
            chests.push(new Chest(200 + Math.random() * (state.mapWidth - 400), canvas.height * GROUND_Y - 10));
        }
    }
    updateUI();
}

player.interact = function() {
    let foundNpc = false;
    villagers.forEach(v => {
        if (!v.dead && Math.abs(player.x - v.x) < 80) { foundNpc = true; handleNpcDialog(v.emoji); }
    });
    // Town merchant check
    if (!foundNpc && locations[state.location].type === 'town' && Math.abs(player.x - (state.mapWidth/2)) < 300) {
        handleNpcDialog('üë®‚Äçüåæ');
    }
    chests.forEach(c => {
        if (!c.opened && Math.abs(player.x - c.x) < 60) {
            c.opened = true;
            state.chestsFound.push(c.id);
            const reward = 200 + Math.floor(Math.random() * 500);
            state.gold += reward;
            if (Math.random() > 0.5) {
                droppedItems.push(new DroppedItem(c.x, c.y - 20, 'heart'));
                showDialog("ÏãúÏä§ÌÖú", `ÏÉÅÏûêÏóêÏÑú ${reward}GÏôÄ Î¨ºÏïΩÏùÑ Î∞úÍ≤¨ÌñàÏäµÎãàÎã§!`);
            } else {
                showDialog("ÏãúÏä§ÌÖú", `Ïà®Í≤®ÏßÑ Î≥¥Î¨º ${reward}GÎ•º Î∞úÍ≤¨ÌñàÏäµÎãàÎã§!`);
            }
            spawnParticle(c.x, c.y, '#ffd700', 20);
            updateUI();
        }
    });
};

function handleNpcDialog(emoji) {
    let name = "Ï£ºÎØº", text = "ÏïàÎÖïÌïòÏÑ∏Ïöî, Î™®ÌóòÍ∞ÄÎãò!", btns = [{t: "Îã´Í∏∞", f: closeDialog}];
    if (emoji === 'üë®‚Äçüåæ') {
        name = "ÎåÄÏû•Ïû•Ïù¥";
        text = "Ïñ¥ÏÑúÏò§Í≤å! Î¨¥ÏóáÏùÑ ÎèÑÏôÄÏ§ÑÍπå?";
        btns = [
            {t: "Ï†ÑÎ¶¨Ìíà ÌåêÎß§", f: sellLoot},
            {t: "ÏÉÅÏ†ê Ïó¥Í∏∞", f: toggleShop},
            {t: "Ï≤¥Î†• ÌöåÎ≥µ(100G)", f: healPlayer},
            {t: "Îã´Í∏∞", f: closeDialog}
        ];
        if (state.questStep === 0) {
            state.questStep = 1;
            text = "ÏöîÏ¶ò Î™¨Ïä§ÌÑ∞Îì§Ïù¥ ÌùâÌè¨Ìï¥Ï°åÏñ¥. 5ÎßàÎ¶¨Îßå Ï≤òÎ¶¨Ìï¥Ï£ºÎ©¥ ÏÇ¨Î°ÄÌïòÍ≤†ÎÑ§.";
            checkQuest();
        } else if (state.questStep === 2) {
            state.questStep = 3; state.gold += 1000; gainXp(100);
            text = "Ïò§! Ï†ïÎßê ÌõåÎ•≠Ìïú Ïã§Î†•Ïù¥Íµ∞! Ïó¨Í∏∞ Î≥¥ÏÉÅÏùºÏÑ∏. (+1000G, +100XP)";
            checkQuest();
        }
    } else if (emoji === 'üë¥') { name = "Ï¥åÏû•"; text = "ÎèôÏ™Ω ÎÅù ÎßàÏôïÏùò ÏÑ±Ïóê Ï†ÑÏÑ§Ïùò Î≥¥Î¨ºÏù¥ ÏûàÎã§Îäî ÏÜåÎ¨∏Ïù¥..."; }
    showDialog(name, text, btns);
}

function healPlayer() {
    if (state.gold >= 100) {
        state.gold -= 100; state.hp = state.maxHp; updateUI();
        spawnParticle(player.x, player.y, '#00ff00', 15);
        showDialog("ÎåÄÏû•Ïû•Ïù¥", "Ï≤¥Î†•Ïù¥ Î™®Îëê ÌöåÎ≥µÎêòÏóàÎÑ§!");
    } else showDialog("ÎåÄÏû•Ïû•Ïù¥", "Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±ÌïòÍµ∞...");
}

function showDialog(name, text, buttons = [{t: "Îã´Í∏∞", f: closeDialog}]) {
    document.getElementById('speaker-name').innerText = name;
    document.getElementById('dialog-text').innerText = text;
    const btnContainer = document.getElementById('dialog-buttons');
    btnContainer.innerHTML = '';
    buttons.forEach(b => {
        const btn = document.createElement('button');
        btn.className = "bg-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold";
        btn.innerText = b.t;
        btn.onclick = b.f;
        btnContainer.appendChild(btn);
    });
    document.getElementById('dialog').style.display = 'block';
}

function checkQuest() {
    const q = document.getElementById('quest-desc');
    if (state.questStep === 0) q.innerText = "ÎåÄÏû•Ïû•Ïù¥ÏôÄ ÎåÄÌôî";
    else if (state.questStep === 1) {
        q.innerText = `Î™¨Ïä§ÌÑ∞ ÏÇ¨ÎÉ• (${state.kills}/5)`;
        if (state.kills >= 5) { state.questStep = 2; checkQuest(); }
    } else if (state.questStep === 2) q.innerText = "ÎåÄÏû•Ïû•Ïù¥ÏóêÍ≤å Î≥¥Í≥†";
    else if (state.questStep === 3) q.innerText = "ÎßàÏôïÏùò ÏÑ± ÌÜ†Î≤å";
}

function updateCamera() {
    // Camera follows player
    camera.x = player.x - canvas.width / 2;
    // Clamp camera to map bounds
    if (camera.x < 0) camera.x = 0;
    if (camera.x > state.mapWidth - canvas.width) camera.x = state.mapWidth - canvas.width;
}

function drawBackground() {
    const loc = locations[state.location];
    
    // 1. Sky (Fixed)
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0); 
    ctx.fillStyle = loc.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    if (loc.weather === 'rain') { ctx.fillStyle = 'rgba(0,0,100,0.1)'; ctx.fillRect(0,0,canvas.width, canvas.height); }
    if (loc.weather === 'dark') { ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(0,0,canvas.width, canvas.height); }
    ctx.restore();

    // 2. Parallax Mountains (Moves slower)
    ctx.save();
    ctx.translate(-camera.x * 0.5, 0); // 50% speed
    ctx.fillStyle = 'rgba(0,0,0,0.15)'; // Shadowy mountains
    ctx.beginPath();
    for(let i=0; i<state.mapWidth; i+=400) {
        ctx.moveTo(i, canvas.height * GROUND_Y);
        ctx.lineTo(i+200, canvas.height * 0.4);
        ctx.lineTo(i+400, canvas.height * GROUND_Y);
    }
    ctx.fill();
    ctx.restore();

    // 3. Ground (Moves normal)
    ctx.save();
    ctx.translate(-camera.x, 0);
    ctx.fillStyle = 'rgba(0,0,0,0.2)';
    ctx.fillRect(0, canvas.height * GROUND_Y, state.mapWidth, canvas.height * (1-GROUND_Y));
    
    // Background Objects
    ctx.font = '80px serif';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#FFF';
    
    if (loc.type === 'town') {
        // Draw buildings across the town
        for(let i=150; i<state.mapWidth; i+=600) {
             ctx.fillText(i%1200===150?'üè†':'üèõÔ∏è', i, canvas.height * GROUND_Y);
        }
        ctx.fillText('üë®‚Äçüåæ', state.mapWidth/2, canvas.height * GROUND_Y - 10);
    } else if (loc.type === 'field') {
        ctx.font = '40px serif';
        ctx.globalAlpha = 0.5;
        // Draw trees/cactus along the path
        const decor = state.location.includes('forest') ? 'üå≤' : (state.location.includes('desert') ? 'üåµ' : 'ü™®');
        for(let i=100; i<state.mapWidth; i+=300) {
            ctx.fillText(decor, i + (Math.sin(i)*50), canvas.height * GROUND_Y - 20);
        }
        ctx.globalAlpha = 1;
    }
    ctx.restore();
}

function updateUI() {
    document.getElementById('gold').innerText = state.gold;
    document.getElementById('power').innerText = state.attackPower;
    document.getElementById('loot').innerText = state.loot;
    document.getElementById('location-name').innerText = locations[state.location].name;
    document.getElementById('level').innerText = state.level;
    document.getElementById('hp').innerText = Math.floor(state.hp);
    document.getElementById('max-hp').innerText = state.maxHp;
    document.getElementById('shop-gold').innerText = state.gold;
    const xpPercent = (state.xp / state.maxXp) * 100;
    document.getElementById('xp-bar').style.width = `${xpPercent}%`;
}

function sellLoot() {
    if (state.loot > 0) {
        const gain = state.loot * 30;
        state.gold += gain; state.loot = 0; updateUI();
        showDialog("ÎåÄÏû•Ïû•Ïù¥", `${gain}GÏóê Îß§ÏûÖÌñàÎÑ§.`);
    } else showDialog("ÎåÄÏû•Ïû•Ïù¥", "Ï†ÑÎ¶¨ÌíàÏù¥ ÏóÜÍµ∞.");
}

function closeDialog() { 
    document.getElementById('dialog').style.display = 'none'; 
    document.getElementById('shop').style.display = 'none'; 
}

const shopItems = [
    { name: "ÏàòÏäµ Í∏∞ÏÇ¨Ïùò Í≤Ä", power: 25, price: 200, level: 2 },
    { name: "Ï†ïÏòàÎ≥ëÏùò Í∞ïÏ≤†Í≤Ä", power: 50, price: 600, level: 3 },
    { name: "ÌôîÏóºÏùò Î£¨Í≤Ä", power: 120, price: 1500, level: 4 },
    { name: "Ïö©ÏÇ¨ÎÉ•ÍæºÏùò ÎåÄÍ≤Ä", power: 300, price: 4000, level: 5 },
    { name: "Ï†ÑÏÑ§Ïùò ÏóëÏä§ÏπºÎ¶¨Î≤Ñ", power: 800, price: 10000, level: 6 },
    { name: "ÏµúÏÉÅÍ∏â Ï≤¥Î†• Î¨ºÏïΩ", power: 0, price: 500, level: 99, type: 'potion' }
];

function toggleShop() {
    state.shopVisible = !state.shopVisible;
    document.getElementById('shop').style.display = state.shopVisible ? 'block' : 'none';
    if (state.shopVisible) {
        const container = document.getElementById('shop-items');
        container.innerHTML = '';
        shopItems.forEach(item => {
            const isPotion = item.type === 'potion';
            const owned = !isPotion && state.weaponLevel >= item.level;
            const btn = document.createElement('div');
            btn.className = "flex justify-between items-center bg-gray-700 p-2 rounded-lg border border-gray-600";
            btn.innerHTML = `<div class="text-sm"><div class="font-bold text-yellow-400">${item.name}</div><div class="text-xs text-gray-300">${isPotion ? 'Ï≤¥Î†• ÌöåÎ≥µ' : 'Í≥µÍ≤©Î†•: ' + item.power}</div></div>
                <button onclick="buyItem(${item.level}, ${item.price}, ${item.power}, '${item.type}')" class="px-3 py-1 rounded text-xs font-bold ${owned ? 'bg-gray-500' : 'bg-orange-500'}" ${owned ? 'disabled' : ''}>${owned ? 'Î≥¥Ïú†Ï§ë' : item.price + 'G'}</button>`;
            container.appendChild(btn);
        });
        updateUI();
    }
}

window.buyItem = function(lvl, price, pwr, type) {
    if (state.gold >= price) {
        if (type === 'potion') {
            state.gold -= price; state.hp = state.maxHp;
            showDialog("ÏÉÅÏ†ê", "Ï≤¥Î†• ÌöåÎ≥µ!");
        } else {
            state.gold -= price; state.weaponLevel = lvl; state.attackPower = pwr + (state.level * 2);
        }
        updateUI(); toggleShop(); toggleShop(); 
        spawnParticle(player.x, player.y, '#00ff00', 20);
    } else alert("Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!");
};

function setupControls() {
    const bind = (id, key) => {
        const el = document.getElementById(id);
        el.onmousedown = el.ontouchstart = (e) => { e.preventDefault(); initAudio(); keys[key] = true; };
        el.onmouseup = el.ontouchend = (e) => { e.preventDefault(); keys[key] = false; };
    };
    bind('btn-left', 'left'); bind('btn-right', 'right'); bind('btn-jump', 'jump');
    document.getElementById('btn-attack').onclick = () => { initAudio(); player.attack(); };
    document.getElementById('btn-action').onclick = () => { initAudio(); player.interact(); };
    document.getElementById('btn-dash').onclick = () => { initAudio(); player.dash(); };
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Shake Effect
    if (state.screenShake > 0) {
        const dx = (Math.random() - 0.5) * state.screenShake;
        const dy = (Math.random() - 0.5) * state.screenShake;
        ctx.translate(dx, dy);
        state.screenShake *= 0.9;
        if (state.screenShake < 0.5) state.screenShake = 0;
    }

    updateCamera(); // Update Camera Position

    drawBackground(); // Draws parallax background

    // Apply Camera Transform for Game World
    ctx.save();
    ctx.translate(-camera.x, 0);

    chests.forEach(c => c.draw());
    droppedItems.forEach(i => { i.update(); i.draw(); });

    player.update(); player.draw();

    if (locations[state.location].type === 'town') {
        villagers.forEach(v => { v.update(); v.draw(); });
    } else {
        monsters.forEach(m => { m.update(); m.draw(); });
    }

    // Damage Texts
    damageTexts.forEach((d, i) => { d.update(); d.draw(); if(d.life <= 0) damageTexts.splice(i,1); });

    // Weather Particles (Rain/Snow) - Need to be independent of camera or handled carefully
    // In this simple implementation, we draw weather in screen space (UI layer)
    ctx.restore(); // Restore camera transform

    // Draw Weather Particles (Screen Space)
    ctx.save();
    particles.forEach((p, i) => {
        p.update();
        // If normal particle (hit effect), it should be world space. 
        // If weather, screen space.
        if(p.type === 'normal') {
            // Re-apply camera for normal particles
            ctx.save();
            ctx.translate(-camera.x, 0);
            p.draw();
            ctx.restore();
        } else {
            p.draw();
        }
        if (p.life <= 0) particles.splice(i, 1);
    });
    ctx.restore();
    
    // Reset transform from shake
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    
    requestAnimationFrame(loop);
}

setupControls();
changeLocation();
checkQuest();
requestAnimationFrame(loop);
</script>
</body>
</html>
