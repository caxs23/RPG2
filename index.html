<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¨ë°”ì¼ íš¡ìŠ¤í¬ë¡¤ RPG: ì—í”½ ì›”ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Arial', sans-serif;
            user-select: none;
            touch-action: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        canvas {
            display: block;
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        /* ìƒë‹¨ UI ë ˆì´ì•„ì›ƒ ìµœì í™” */
        .top-ui {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: auto;
        }
        .status-card {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            color: white;
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .quest-card {
            background: rgba(251, 191, 36, 0.9);
            color: #000;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            align-self: flex-end;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ëŸ¬ ìµœì í™” */
        .controls {
            position: absolute;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            pointer-events: auto;
        }
        .control-group {
            display: flex;
            gap: 10px;
        }
        .btn {
            width: 55px;
            height: 55px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            transition: all 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        .btn:active { transform: scale(0.85); background: rgba(255,255,255,0.6); }
        .btn-action { background: rgba(237, 137, 54, 0.5); border-color: #ed8936; }
        .btn-attack { background: rgba(245, 101, 101, 0.5); border-color: #f56565; }

        .dialog-box {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            background: rgba(45, 55, 72, 0.95);
            border: 2px solid #718096;
            padding: 15px;
            border-radius: 12px;
            display: none;
            pointer-events: auto;
            z-index: 100;
            color: white;
        }
        .shop-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a202c;
            padding: 20px;
            border-radius: 16px;
            display: none;
            pointer-events: auto;
            z-index: 101;
            width: 85%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #ed8936;
        }
        #hidden-media { display: none; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="hidden-media">
        <video id="jump-sound-vid" src="https://github.com/caxs23/runandjump/blob/main/jump.mp4?raw=true" preload="auto"></video>
        <audio id="bgm" src="https://orangefreesounds.com/wp-content/uploads/2021/05/Light-fantasy-background-music.mp3" loop></audio>
    </div>

    <div class="ui-overlay">
        <div class="top-ui">
            <div class="status-card">
                <div class="flex gap-3">
                    <span>ğŸ’° <span id="gold">0</span></span>
                    <span>âš”ï¸ <span id="power">10</span></span>
                    <span>ğŸ“¦ <span id="loot">0</span></span>
                </div>
                <div class="font-bold text-yellow-400">ğŸ“ <span id="location-name">ë§ˆì„</span></div>
            </div>
            <div id="quest-ui" class="quest-card">
                ğŸ“œ <span id="quest-desc">ìƒì¸ê³¼ ëŒ€í™”í•˜ê¸°</span>
            </div>
        </div>

        <div id="dialog" class="dialog-box">
            <div id="speaker-name" class="font-bold text-blue-300 mb-1">ìƒì¸</div>
            <p id="dialog-text" class="text-sm">ì „ë¦¬í’ˆì„ íŒ”ëŸ¬ ì™”ë‚˜?</p>
            <div id="dialog-buttons" class="mt-3 flex flex-wrap gap-2"></div>
        </div>

        <div id="shop" class="shop-menu text-white">
            <h2 class="text-xl font-bold mb-4 text-orange-400">ì „ì„¤ì˜ ëŒ€ì¥ê°„</h2>
            <div id="shop-items" class="space-y-2"></div>
            <button onclick="toggleShop()" class="mt-4 w-full bg-gray-600 py-2 rounded-xl">ë‹«ê¸°</button>
        </div>

        <div class="controls">
            <div class="control-group">
                <div id="btn-left" class="btn">â—€</div>
                <div id="btn-right" class="btn">â–¶</div>
            </div>
            <div class="control-group">
                <div id="btn-jump" class="btn">UP</div>
                <div id="btn-attack" class="btn btn-attack">ATK</div>
                <div id="btn-action" class="btn btn-action">ACT</div>
            </div>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const jumpVid = document.getElementById('jump-sound-vid');
const bgm = document.getElementById('bgm');

const state = {
    gold: 0,
    loot: 0,
    attackPower: 10,
    weaponLevel: 1,
    location: 'town_start',
    dialogVisible: false,
    shopVisible: false,
    audioInitialized: false,
    questStep: 0,
    kills: 0,
    chestsFound: []
};

const locations = {
    'town_start': { name: 'ì‹œì‘ì˜ ë§ˆì„', next: 'field_slime', prev: null, bg: '#87CEEB', type: 'town' },
    'field_slime': { name: 'í‰ì˜¨í•œ ë“¤íŒ', next: 'field_forest', prev: 'town_start', bg: '#7cfc00', type: 'field', enemy: 'ğŸ°' },
    'field_forest': { name: 'ê¹Šì€ ìˆ²', next: 'field_bridge', prev: 'field_slime', bg: '#2d5a27', type: 'field', enemy: 'ğŸ¦Š' },
    'field_bridge': { name: 'ë¶€ì„œì§„ ë‹¤ë¦¬', next: 'town_second', prev: 'field_forest', bg: '#4a7c59', type: 'field', enemy: 'ğŸ—' },
    'town_second': { name: 'ë¬´ì—­ ë„ì‹œ', next: 'field_desert', prev: 'field_bridge', bg: '#fbd38d', type: 'town' },
    'field_desert': { name: 'í™©ê¸ˆ ì‚¬ë§‰', next: 'field_oasis', prev: 'town_second', bg: '#ecc94b', type: 'field', enemy: 'ğŸ¦‚' },
    'field_oasis': { name: 'ì˜¤ì•„ì‹œìŠ¤', next: 'field_cave', prev: 'field_desert', bg: '#4fd1c5', type: 'field', enemy: 'ğŸ' },
    'field_cave': { name: 'ì–´ë‘ìš´ ë™êµ´', next: 'field_volcano', prev: 'field_oasis', bg: '#2d3748', type: 'field', enemy: 'ğŸ¦‡' },
    'field_volcano': { name: 'ìš©ì•” ì§€ëŒ€', next: 'town_castle', prev: 'field_cave', bg: '#c53030', type: 'field', enemy: 'ğŸ”¥' },
    'town_castle': { name: 'ì™•ê¶ ì„±ë²½', next: 'field_sky', prev: 'field_volcano', bg: '#718096', type: 'town' },
    'field_sky': { name: 'í•˜ëŠ˜ ì„¬', next: 'boss_lair', prev: 'town_castle', bg: '#ebf8ff', type: 'field', enemy: 'ğŸ¦…' },
    'boss_lair': { name: 'ë§ˆì™•ì˜ ì„±', next: null, prev: 'field_sky', bg: '#1a202c', type: 'field', enemy: 'ğŸ‘¿' }
};

const playerImg1 = new Image(); playerImg1.src = 'https://github.com/caxs23/plaffy-bird/blob/main/1-removebg-preview.png?raw=true';
const playerImg2 = new Image(); playerImg2.src = 'https://github.com/caxs23/plaffy-bird/blob/main/2-removebg-preview.png?raw=true';

const GRAVITY = 0.6;
const GROUND_Y = 0.75; // ëª¨ë°”ì¼ í™”ë©´ ë¹„ìœ¨ì— ë§ì¶° ì¡°ê¸ˆ ì˜¬ë¦¼

function resize() { 
    canvas.width = window.innerWidth; 
    canvas.height = window.innerHeight; 
}
window.addEventListener('resize', resize);
resize();

const keys = { left: false, right: false, jump: false };
const particles = [];

function initAudio() {
    if (!state.audioInitialized) { bgm.play().catch(() => {}); state.audioInitialized = true; }
}

function playJumpEffect() { jumpVid.currentTime = 0; jumpVid.play().catch(() => {}); }

function createEffect(x, y, color, count = 10) {
    for (let i = 0; i < count; i++) {
        particles.push({
            x, y,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            life: 1.0,
            color: color
        });
    }
}

class Entity {
    constructor(x, y, size, emoji, hp = 0, isNpc = false) {
        this.x = x; this.y = y; this.size = size; this.emoji = emoji;
        this.hp = hp; this.initialHp = hp;
        this.dead = false; this.vx = 0; this.moveTimer = 0;
        this.isNpc = isNpc;
        this.hitTimer = 0;
    }

    update() {
        if (this.dead) return;
        this.moveTimer--;
        if (this.moveTimer <= 0) {
            this.moveTimer = 60 + Math.random() * 120;
            const r = Math.random();
            this.vx = r < 0.3 ? 0 : (r < 0.65 ? 1 : -1);
        }
        this.x += this.vx * (this.isNpc ? 0.3 : 0.8);
        if (this.x < 50) this.vx = 1;
        if (this.x > canvas.width - 50) this.vx = -1;
        if (this.hitTimer > 0) this.hitTimer--;
    }

    draw() {
        if (this.dead) return;
        ctx.save();
        if (this.hitTimer > 0) ctx.filter = 'brightness(2) sepia(1) hue-rotate(-50deg)';
        ctx.font = `${this.size}px serif`;
        ctx.textAlign = 'center';
        ctx.fillStyle = '#FFFFFF';
        ctx.fillText(this.emoji, this.x, this.y + this.size);
        if (this.hp > 0) {
            const barW = this.size;
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(this.x - barW/2, this.y - 15, barW, 4);
            ctx.fillStyle = '#00FF00';
            ctx.fillRect(this.x - barW/2, this.y - 15, barW * (this.hp / this.initialHp), 4);
        }
        ctx.restore();
    }
}

class Chest {
    constructor(x, y) {
        this.x = x; this.y = y; this.id = `${state.location}_${Math.floor(x)}`;
        this.opened = state.chestsFound.includes(this.id);
    }
    draw() {
        ctx.save();
        ctx.font = '40px serif';
        ctx.textAlign = 'center';
        ctx.fillText(this.opened ? 'ğŸ”“' : 'ğŸ', this.x, this.y);
        ctx.restore();
    }
}

const player = {
    x: 100, y: 0, width: 70, height: 65, vx: 0, vy: 0,
    speed: 5.5, jumpPower: -12, isGrounded: false, direction: 1,
    frame: 0, walkCounter: 0, isAttacking: false, attackCooldown: 0,

    update() {
        if (keys.left) { this.vx = -this.speed; this.direction = -1; this.walkCounter++; }
        else if (keys.right) { this.vx = this.speed; this.direction = 1; this.walkCounter++; }
        else { this.vx *= 0.8; this.walkCounter = 0; }

        if (keys.jump && this.isGrounded) { this.vy = this.jumpPower; this.isGrounded = false; playJumpEffect(); }
        this.vy += GRAVITY; this.x += this.vx; this.y += this.vy;

        const g = canvas.height * GROUND_Y - this.height;
        if (this.y > g) { this.y = g; this.vy = 0; this.isGrounded = true; }

        const loc = locations[state.location];
        if (this.x < -20 && loc.prev) { state.location = loc.prev; this.x = canvas.width - 100; changeLocation(); }
        if (this.x > canvas.width - 40 && loc.next) { state.location = loc.next; this.x = 20; changeLocation(); }

        if (this.attackCooldown > 0) this.attackCooldown--;
        if (this.attackCooldown < 12) this.isAttacking = false;
        this.frame = (Math.floor(this.walkCounter / 8) % 2);
    },

    draw() {
        ctx.save();
        if (this.direction === -1) { ctx.scale(-1, 1); ctx.translate(-this.x - this.width, this.y); }
        else { ctx.translate(this.x, this.y); }
        const img = (this.walkCounter > 0 || !this.isGrounded) ? (this.frame === 0 ? playerImg1 : playerImg2) : playerImg1;
        
        if (this.isAttacking) {
            ctx.strokeStyle = 'rgba(255,255,255,0.7)';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(this.width, this.height/2, 35, -Math.PI/2, Math.PI/2);
            ctx.stroke();
        }
        ctx.drawImage(img, 0, 0, this.width, this.height);
        ctx.restore();
    },

    attack() {
        if (this.attackCooldown > 0) return;
        this.isAttacking = true; this.attackCooldown = 25;
        createEffect(this.x + this.width/2, this.y + this.height/2, '#fff', 5);
        
        const targets = [...monsters, ...villagers];
        targets.forEach(m => {
            if (!m.dead) {
                const dist = Math.abs((this.x + this.width/2) - m.x);
                if (dist < 100) {
                    m.hp -= state.attackPower;
                    m.hitTimer = 10;
                    createEffect(m.x, m.y + m.size/2, '#ff0000', 8);
                    if (m.isNpc) { showDialog("ì£¼ë¯¼", "ìœ¼ì•…! ì™œ ì´ëŸ¬ì‹œëŠ” ê²ë‹ˆê¹Œ!"); m.vx = this.direction * 3; }
                    if (m.hp <= 0) {
                        m.dead = true;
                        if (!m.isNpc) { state.loot++; state.kills++; checkQuest(); }
                        else { state.gold = Math.max(0, state.gold - 50); }
                        updateUI();
                    }
                }
            }
        });
    },

    interact() {
        let foundNpc = false;
        villagers.forEach(v => {
            if (!v.dead && Math.abs(this.x - v.x) < 80) { foundNpc = true; handleNpcDialog(v.emoji); }
        });
        if (!foundNpc && locations[state.location].type === 'town' && Math.abs(this.x - canvas.width/2) < 80) {
            handleNpcDialog('ğŸ‘¨â€ğŸŒ¾');
        }
        chests.forEach(c => {
            if (!c.opened && Math.abs(this.x - c.x) < 50) {
                c.opened = true;
                state.chestsFound.push(c.id);
                const reward = 100 + Math.floor(Math.random() * 400);
                state.gold += reward;
                createEffect(c.x, c.y, '#ffd700', 20);
                showDialog("ì‹œìŠ¤í…œ", `ìˆ¨ê²¨ì§„ ë³´ë¬¼ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤! (+${reward}G)`);
                updateUI();
            }
        });
    }
};

const monsters = [];
const villagers = [];
const chests = [];

function changeLocation() {
    monsters.length = 0; villagers.length = 0; chests.length = 0;
    const loc = locations[state.location];
    if (loc.type === 'town') {
        for (let i = 0; i < 2; i++) {
            villagers.push(new Entity(100 + Math.random() * (canvas.width - 200), canvas.height * GROUND_Y - 45, 50, ['ğŸ‘¦', 'ğŸ‘©', 'ğŸ‘´', 'ğŸ‘®'][Math.floor(Math.random()*4)], 100, true));
        }
    } else {
        const count = state.location === 'boss_lair' ? 1 : 3;
        const hpBase = state.location === 'boss_lair' ? 2000 : 30 * (Object.keys(locations).indexOf(state.location));
        for (let i = 0; i < count; i++) {
            monsters.push(new Entity(300 + Math.random() * (canvas.width - 400), canvas.height * GROUND_Y - 55, 55, loc.enemy, hpBase));
        }
    }
    if (Math.random() > 0.4) {
        chests.push(new Chest(Math.random() * (canvas.width - 100) + 50, canvas.height * GROUND_Y - 10));
    }
    updateUI();
}

function handleNpcDialog(emoji) {
    let name = "ì£¼ë¯¼", text = "ì•ˆë…•í•˜ì„¸ìš”, ëª¨í—˜ê°€ë‹˜!", btns = [{t: "ë‹«ê¸°", f: closeDialog}];
    if (emoji === 'ğŸ‘¨â€ğŸŒ¾') {
        name = "ìƒì¸";
        text = "ê°•í™”ë‚˜ ì „ë¦¬í’ˆ íŒë§¤ê°€ í•„ìš”í•˜ì‹ ê°€ìš”?";
        btns = [
            {t: "ì „ë¦¬í’ˆ íŒë§¤", f: sellLoot},
            {t: "ëŒ€ì¥ê°„ ìƒì ", f: toggleShop},
            {t: "ë‹«ê¸°", f: closeDialog}
        ];
        if (state.questStep === 0) {
            state.questStep = 1;
            text = "í† ë¼ë¥¼ 5ë§ˆë¦¬ë§Œ ì¡ì•„ë‹¤ ì£¼ì‹œë©´ ë³´ìƒì„ ë“œë¦¬ì£ .";
            checkQuest();
        } else if (state.questStep === 2) {
            state.questStep = 3; state.gold += 500;
            text = "ì˜¤! ì •ë§ ì¡ì•„ì˜¤ì…¨êµ°ìš”! ì—¬ê¸° ì•½ì†í•œ ë³´ìƒì…ë‹ˆë‹¤.";
            checkQuest();
        }
    } else if (emoji === 'ğŸ‘´') { name = "ì¥ë¡œ"; text = "ì € ë„ˆë¨¸ ë§ˆì™•ì˜ ì„±ì´ ë³´ì´ê¸° ì‹œì‘í•˜ëŠ”êµ¬ë¨¼..."; }
    showDialog(name, text, btns);
}

function showDialog(name, text, buttons = [{t: "ë‹«ê¸°", f: closeDialog}]) {
    document.getElementById('speaker-name').innerText = name;
    document.getElementById('dialog-text').innerText = text;
    const btnContainer = document.getElementById('dialog-buttons');
    btnContainer.innerHTML = '';
    buttons.forEach(b => {
        const btn = document.createElement('button');
        btn.className = "bg-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold";
        btn.innerText = b.t;
        btn.onclick = b.f;
        btnContainer.appendChild(btn);
    });
    document.getElementById('dialog').style.display = 'block';
}

function checkQuest() {
    const q = document.getElementById('quest-desc');
    if (state.questStep === 0) q.innerText = "ìƒì¸ê³¼ ëŒ€í™”í•˜ê¸°";
    else if (state.questStep === 1) {
        q.innerText = `í† ë¼ ì‚¬ëƒ¥ (${state.kills}/5)`;
        if (state.kills >= 5) { state.questStep = 2; checkQuest(); }
    } else if (state.questStep === 2) q.innerText = "ìƒì¸ì—ê²Œ ë³´ê³ í•˜ê¸°";
    else if (state.questStep === 3) q.innerText = "ë§ˆì™•ì˜ ì„± ì°¾ì•„ê°€ê¸°";
}

function drawBackground() {
    const loc = locations[state.location];
    ctx.fillStyle = loc.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,0.1)';
    ctx.fillRect(0, canvas.height * GROUND_Y, canvas.width, canvas.height * (1-GROUND_Y));
    ctx.restore();
    
    ctx.save();
    ctx.font = '80px serif';
    ctx.textAlign = 'center';
    if (loc.type === 'town') {
        ctx.fillText('ğŸ ', 150, canvas.height * GROUND_Y);
        ctx.fillText('ğŸ›ï¸', canvas.width - 200, canvas.height * GROUND_Y);
        ctx.fillText('ğŸ‘¨â€ğŸŒ¾', canvas.width/2, canvas.height * GROUND_Y - 10);
    }
    ctx.restore();
}

function updateUI() {
    document.getElementById('gold').innerText = state.gold;
    document.getElementById('power').innerText = state.attackPower;
    document.getElementById('loot').innerText = state.loot;
    document.getElementById('location-name').innerText = locations[state.location].name;
}

function sellLoot() {
    if (state.loot > 0) {
        state.gold += state.loot * 25; state.loot = 0; updateUI();
        showDialog("ìƒì¸", "ì „ë¶€ ë§¤ì…í–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!");
    } else showDialog("ìƒì¸", "íŒë§¤í•  ì „ë¦¬í’ˆì´ ì—†ìœ¼ì‹œë„¤ìš”.");
}

function closeDialog() { 
    document.getElementById('dialog').style.display = 'none'; 
    document.getElementById('shop').style.display = 'none'; 
}

const shopItems = [
    { name: "ê°•ì²  ê²€", power: 40, price: 200, level: 2 },
    { name: "ì•”í‘ ëŒ€ê²€", power: 100, price: 800, level: 3 },
    { name: "ì„±ê²€ ì—‘ìŠ¤ì¹¼ë¦¬ë²„", power: 300, price: 3000, level: 4 },
    { name: "ë§ˆì™• ì²˜ë‹¨ì", power: 1000, price: 10000, level: 5 }
];

function toggleShop() {
    state.shopVisible = !state.shopVisible;
    document.getElementById('shop').style.display = state.shopVisible ? 'block' : 'none';
    if (state.shopVisible) {
        const container = document.getElementById('shop-items');
        container.innerHTML = '';
        shopItems.forEach(item => {
            const owned = state.weaponLevel >= item.level;
            const btn = document.createElement('div');
            btn.className = "flex justify-between items-center bg-gray-800 p-2.5 rounded-lg";
            btn.innerHTML = `<div class="text-sm"><div class="font-bold text-yellow-400">${item.name}</div><div class="text-[10px]">íŒŒì›Œ: ${item.power}</div></div>
                <button onclick="buyItem(${item.level}, ${item.price}, ${item.power})" class="px-3 py-1 rounded-md text-xs ${owned ? 'bg-gray-600' : 'bg-orange-500'}" ${owned ? 'disabled' : ''}>${owned ? 'ë³´ìœ ì¤‘' : item.price + 'G'}</button>`;
            container.appendChild(btn);
        });
    }
}

window.buyItem = function(lvl, price, pwr) {
    if (state.gold >= price) {
        state.gold -= price; state.weaponLevel = lvl; state.attackPower = pwr;
        updateUI(); toggleShop(); toggleShop();
        createEffect(player.x + player.width/2, player.y, '#00ff00', 15);
    }
};

function setupControls() {
    const bind = (id, key) => {
        const el = document.getElementById(id);
        el.onmousedown = el.ontouchstart = (e) => { e.preventDefault(); initAudio(); keys[key] = true; };
        el.onmouseup = el.ontouchend = (e) => { e.preventDefault(); keys[key] = false; };
    };
    bind('btn-left', 'left'); bind('btn-right', 'right'); bind('btn-jump', 'jump');
    document.getElementById('btn-attack').onclick = () => { initAudio(); player.attack(); };
    document.getElementById('btn-action').onclick = () => { initAudio(); player.interact(); };
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackground();
    
    ctx.save();
    for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx; p.y += p.vy; p.life -= 0.02;
        if (p.life <= 0) { particles.splice(i, 1); } 
        else {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 3, 3);
        }
    }
    ctx.restore();

    chests.forEach(c => c.draw());
    player.update(); player.draw();

    if (locations[state.location].type === 'town') {
        villagers.forEach(v => { v.update(); v.draw(); });
    } else {
        monsters.forEach(m => { m.update(); m.draw(); });
    }
    
    requestAnimationFrame(loop);
}

setupControls();
changeLocation();
checkQuest();
requestAnimationFrame(loop);
</script>
</body>
</html>
